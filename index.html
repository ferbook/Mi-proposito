<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mi Ritmo Emocional</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#6a4c93" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Nunito', sans-serif;
      background: #fdf7f2;
      margin: 0;
      padding: 0;
      color: #444;
      transition: background 0.3s, color 0.3s;
    }
    header {
      background: linear-gradient(to right, #6a4c93, #b5838d);
      color: white;
      text-align: center;
      padding: 1.5rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    main {
      max-width: 700px;
      margin: auto;
      padding: 1rem;
    }
    h2 {
      color: #6a4c93;
    }
    section {
      background: white;
      margin-bottom: 1.5rem;
      padding: 1.2rem;
      border-radius: 15px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    }
    label {
      display: block;
      margin-top: 0.6rem;
    }
    input, select, textarea {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.25rem;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      background: #6a4c93;
      color: white;
      border: none;
      padding: 0.8rem 1.5rem;
      margin-top: 1rem;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover {
      background: #5a3a85;
    }
    canvas {
      margin-top: 1rem;
    }
    body.modo-oscuro {
      background: #2e2e3a;
      color: #f0e6ff;
    }
    body.modo-oscuro header {
      background: linear-gradient(to right, #4e327e, #6a4c93);
    }
    body.modo-oscuro section {
      background: #3c3c4f;
    }
    body.modo-oscuro input,
    body.modo-oscuro select,
    body.modo-oscuro textarea {
      background: #2e2e3a;
      color: #f0e6ff;
      border: 1px solid #999;
    }
  </style>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js');
      });
    }
  </script>
</head>
<body>
  <header>
    <h1>ðŸŒŸ Mi Ritmo Emocional</h1>
    <p>Tu espacio diario de autocuidado</p>
    <button onclick="alternarModo()">ðŸŒ“ Modo Oscuro</button>
  </header>
  <main>
    <section>
      <h2>Registro Diario</h2>
      <label for="emocion">Â¿CÃ³mo te sientes hoy?</label>
      <select id="emocion">
        <option value="5">Muy feliz</option>
        <option value="4">Tranquilo</option>
        <option value="3">Ansioso</option>
        <option value="2">Irritable</option>
        <option value="1">Triste</option>
      </select>
      <label for="nota">Â¿Quieres escribir algo mÃ¡s?</label>
      <textarea id="nota" rows="3" placeholder="Hoy sentÃ­ que..."></textarea>
      <label for="horaDormir">Â¿A quÃ© hora te dormiste?</label>
      <input type="time" id="horaDormir">
      <label for="horaDespertar">Â¿A quÃ© hora te despertaste?</label>
      <input type="time" id="horaDespertar">
      <label for="calidadSueÃ±o">Â¿CÃ³mo dormiste?</label>
      <select id="calidadSueÃ±o">
        <option>Muy mal</option>
        <option>Mal</option>
        <option>Regular</option>
        <option>Bien</option>
        <option>Muy bien</option>
      </select>
      <label for="energia">Â¿QuÃ© nivel de energÃ­a tienes hoy? (1-10)</label>
      <input type="number" id="energia" min="1" max="10">
      <label for="medicacion">Â¿Tomaste tu medicaciÃ³n hoy?</label>
      <select id="medicacion">
        <option>SÃ­</option>
        <option>No</option>
        <option>No aplica</option>
      </select>
      <button onclick="guardarDatos()">Guardar Registro</button>
      <button onclick="exportarDatos()">Exportar Todo</button>
      <button onclick="mostrarHistorial()">ðŸ“… Ver Historial</button>
      <div id="historial"></div>
    </section>
    <section>
      <h2>Historial de la Semana</h2>
      <canvas id="graficaEmocion"></canvas>
      <canvas id="graficaEnergia"></canvas>
    </section>
  </main>
  <audio id="sonido" src="https://www.soundjay.com/buttons/sounds/button-09.mp3" preload="auto"></audio>
  <script>
    function alternarModo() {
      const dark = document.body.classList.toggle("modo-oscuro");
      localStorage.setItem("modoOscuro", dark);
    }
    if (localStorage.getItem("modoOscuro") === "true") {
      document.body.classList.add("modo-oscuro");
    }

    function solicitarPermisoNotificaciones() {
      if (Notification && Notification.permission !== "granted") {
        Notification.requestPermission().then(perm => {
          if (perm === "granted") {
            new Notification("No olvides registrar cÃ³mo te sientes hoy ðŸŒ±");
          }
        });
      }
    }

    function programarRecordatorioDiario() {
      if ('Notification' in window && Notification.permission === 'granted') {
        const ahora = new Date();
        const objetivo = new Date();
        objetivo.setHours(20, 0, 0, 0);
        if (ahora > objetivo) objetivo.setDate(objetivo.getDate() + 1);
        const tiempo = objetivo - ahora;
        setTimeout(() => {
          new Notification("ðŸŒ™ Â¿Ya registraste cÃ³mo te sentiste hoy?");
          programarRecordatorioDiario();
        }, tiempo);
      }
    }

    function guardarDatos() {
      const fecha = new Date().toLocaleDateString("es-MX");
      const datos = {
        emocion: document.getElementById('emocion').value,
        nota: document.getElementById('nota').value,
        horaDormir: document.getElementById('horaDormir').value,
        horaDespertar: document.getElementById('horaDespertar').value,
        calidadSueÃ±o: document.getElementById('calidadSueÃ±o').value,
        energia: document.getElementById('energia').value,
        medicacion: document.getElementById('medicacion').value,
        fecha: new Date().toLocaleString("es-MX")
      };
      let historial = JSON.parse(localStorage.getItem('historial')) || {};
      historial[fecha] = datos;
      localStorage.setItem('historial', JSON.stringify(historial));
      document.getElementById("sonido").play();
      alert("Registro guardado âœ¨");
      cargarGraficas();
    }

    function exportarDatos() {
      const historial = localStorage.getItem('historial');
      if (!historial) {
        alert("No hay datos para exportar.");
        return;
      }
      const blob = new Blob([historial], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "mi_historial_emocional.json";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function mostrarHistorial() {
      const contenedor = document.getElementById('historial');
      const datos = JSON.parse(localStorage.getItem('historial')) || {};
      contenedor.innerHTML = '<h3>Historial Completo</h3>';
      Object.keys(datos).forEach(fecha => {
        contenedor.innerHTML += `<p><strong>${fecha}</strong>: Emo ${datos[fecha].emocion}, EnergÃ­a ${datos[fecha].energia}</p>`;
      });
    }

    function cargarGraficas() {
      const historial = JSON.parse(localStorage.getItem('historial')) || {};
      const fechas = [];
      const emociones = [];
      const energias = [];

      Object.keys(historial).slice(-7).forEach(fecha => {
        fechas.push(fecha);
        emociones.push(parseInt(historial[fecha].emocion));
        energias.push(parseInt(historial[fecha].energia));
      });

      new Chart(document.getElementById('graficaEmocion'), {
        type: 'bar',
        data: {
          labels: fechas,
          datasets: [{
            label: 'Estado Emocional (1-5)',
            data: emociones,
            backgroundColor: 'rgba(244,124,124,0.6)',
            borderColor: '#f47c7c',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: true, text: 'EmociÃ³n reciente' }
          },
          scales: {
            y: { min: 1, max: 5 }
          }
        }
      });

      new Chart(document.getElementById('graficaEnergia'), {
        type: 'bar',
        data: {
          labels: fechas,
          datasets: [{
            label: 'Nivel de EnergÃ­a',
            data: energias,
            backgroundColor: 'rgba(106,76,147,0.6)',
            borderColor: '#6a4c93',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: true, text: 'EnergÃ­a reciente' }
          },
          scales: {
            y: { min: 1, max: 10 }
          }
        }
      });
    }

    solicitarPermisoNotificaciones();
    programarRecordatorioDiario();
    cargarGraficas();
  </script>
</body>
</html>